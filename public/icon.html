<!DOCTYPE html>
<html lang="zh-CN" style="width: 64px; height: 64px; margin: 0; padding: 0; overflow: hidden;">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ArtHub Icon</title>
  <style>
    /* 强制重置所有样式，使用 !important 确保优先级最高 */
    * {
      margin: 0 !important;
      padding: 0 !important;
      box-sizing: border-box !important;
    }

    html {
      width: 64px !important;
      height: 64px !important;
      margin: 0 !important;
      padding: 0 !important;
      overflow: hidden !important;
      background: transparent !important;
    }

    body {
      width: 64px !important;
      height: 64px !important;
      margin: 0 !important;
      padding: 0 !important;
      overflow: hidden !important;
      background: transparent !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      cursor: move !important;
      user-select: none !important;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
    }

    #icon-container {
      width: 64px !important;
      height: 64px !important;
      margin: 0 !important;
      padding: 0 !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      overflow: visible !important;
      background: transparent !important;
    }

    #icon {
      width: 56px !important;
      height: 56px !important;
      max-width: 56px !important;
      max-height: 56px !important;
      margin: 0 !important;
      padding: 0 !important;
      object-fit: contain !important;
      object-position: center !important;
      pointer-events: none !important;
      display: block !important;
      background: transparent !important;
    }
  </style>
</head>
<body>
  <div id="icon-container">
    <img id="icon" src="/icon.ico" alt="ArtHub" />
  </div>
  <script>
    // 调试：检查实际尺寸
    window.addEventListener('load', () => {
      const icon = document.getElementById('icon');
      const container = document.getElementById('icon-container');
      const body = document.body;
      const html = document.documentElement;
      
      console.log('=== Icon Window Debug ===');
      console.log('HTML size:', html.offsetWidth, 'x', html.offsetHeight);
      console.log('Body size:', body.offsetWidth, 'x', body.offsetHeight);
      console.log('Container size:', container.offsetWidth, 'x', container.offsetHeight);
      console.log('Icon size:', icon.offsetWidth, 'x', icon.offsetHeight);
      console.log('Icon natural size:', icon.naturalWidth, 'x', icon.naturalHeight);
      console.log('Window size:', window.innerWidth, 'x', window.innerHeight);
    });
    
    // Tauri API 调用
    let invoke;
    
    function getInvoke() {
      if (window.__TAURI_INTERNALS__?.invoke) {
        const fn = window.__TAURI_INTERNALS__.invoke;
        return typeof fn === 'function' ? fn.bind(window.__TAURI_INTERNALS__) : null;
      }
      if (window.__TAURI_INTERNALS__?.core?.invoke) {
        const fn = window.__TAURI_INTERNALS__.core.invoke;
        return typeof fn === 'function' ? fn.bind(window.__TAURI_INTERNALS__.core) : null;
      }
      if (window.__TAURI__?.invoke) {
        const fn = window.__TAURI__.invoke;
        return typeof fn === 'function' ? fn.bind(window.__TAURI__) : null;
      }
      return null;
    }
    
    invoke = getInvoke();
    
    if (!invoke) {
      let retries = 0;
      const interval = setInterval(() => {
        invoke = getInvoke();
        if (invoke || ++retries >= 20) {
          clearInterval(interval);
        }
      }, 100);
    }
    
    let isDragging = false;
    let startMousePos = { x: 0, y: 0 };
    
    document.addEventListener('contextmenu', e => e.preventDefault());
    
    document.addEventListener('mousedown', async (e) => {
      if (e.button === 0) {
        isDragging = true;
        startMousePos = { x: e.screenX, y: e.screenY };
        
        if (!invoke) invoke = getInvoke();
        if (invoke) {
          try {
            await invoke('icon_mouse_down', { x: e.screenX, y: e.screenY });
          } catch (err) {
            console.error('Mouse down error:', err);
          }
        }
        
        e.preventDefault();
      }
    });
    
    document.addEventListener('mousemove', async (e) => {
      if (isDragging) {
        if (!invoke) invoke = getInvoke();
        if (invoke) {
          try {
            await invoke('icon_mouse_move', { x: e.screenX, y: e.screenY });
          } catch (err) {
            console.error('Move error:', err);
          }
        }
        e.preventDefault();
      }
    });
    
    document.addEventListener('mouseup', async (e) => {
      if (e.button === 0 && isDragging) {
        const moved = Math.abs(e.screenX - startMousePos.x) > 3 || 
                      Math.abs(e.screenY - startMousePos.y) > 3;
        isDragging = false;
        
        if (!invoke) invoke = getInvoke();
        if (invoke) {
          try {
            await invoke('icon_mouse_up', { x: e.screenX, y: e.screenY });
            if (!moved) {
              await invoke('icon_click');
            }
          } catch (err) {
            console.error('Mouse up error:', err);
          }
        }
        
        e.preventDefault();
      }
    });
    
    document.addEventListener('selectstart', e => e.preventDefault());
    window.addEventListener('mouseup', () => { isDragging = false; });
    document.addEventListener('mouseleave', () => { isDragging = false; });
  </script>
</body>
</html>
