<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ArtHub Icon</title>
  <style>
    /* 重置所有样式 */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* 窗口固定为 64x64 */
    html, body {
      width: 64px;
      height: 64px;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: transparent;
    }

    body {
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: move;
      user-select: none;
    }

    /* 图标容器：占满整个窗口 */
    #icon-container {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    /* 图标：自适应容器大小，使用 contain 确保完整显示不被裁剪 */
    #icon {
      width: 100%;
      height: 100%;
      object-fit: contain;
      object-position: center;
      pointer-events: none;
      display: block;
    }
  </style>
</head>
<body>
  <div id="icon-container">
    <img id="icon" src="/icon.ico" alt="ArtHub" />
  </div>
  <script>
    // Tauri API 调用
    let invoke;
    
    function getInvoke() {
      if (window.__TAURI_INTERNALS__?.invoke) {
        const fn = window.__TAURI_INTERNALS__.invoke;
        return typeof fn === 'function' ? fn.bind(window.__TAURI_INTERNALS__) : null;
      }
      if (window.__TAURI_INTERNALS__?.core?.invoke) {
        const fn = window.__TAURI_INTERNALS__.core.invoke;
        return typeof fn === 'function' ? fn.bind(window.__TAURI_INTERNALS__.core) : null;
      }
      if (window.__TAURI__?.invoke) {
        const fn = window.__TAURI__.invoke;
        return typeof fn === 'function' ? fn.bind(window.__TAURI__) : null;
      }
      return null;
    }
    
    invoke = getInvoke();
    
    // 延迟加载 Tauri API
    if (!invoke) {
      let retries = 0;
      const interval = setInterval(() => {
        invoke = getInvoke();
        if (invoke || ++retries >= 20) {
          clearInterval(interval);
        }
      }, 100);
    }
    
    let isDragging = false;
    let startMousePos = { x: 0, y: 0 };
    
    // 禁用右键菜单
    document.addEventListener('contextmenu', e => e.preventDefault());
    
    // 鼠标按下
    document.addEventListener('mousedown', async (e) => {
      if (e.button === 0) {
        isDragging = true;
        startMousePos = { x: e.screenX, y: e.screenY };
        
        if (!invoke) invoke = getInvoke();
        if (invoke) {
          try {
            await invoke('icon_mouse_down', { x: e.screenX, y: e.screenY });
          } catch (err) {
            console.error('Mouse down error:', err);
          }
        }
        
        e.preventDefault();
      }
    });
    
    // 鼠标移动
    document.addEventListener('mousemove', async (e) => {
      if (isDragging) {
        if (!invoke) invoke = getInvoke();
        if (invoke) {
          try {
            await invoke('icon_mouse_move', { x: e.screenX, y: e.screenY });
          } catch (err) {
            console.error('Move error:', err);
          }
        }
        e.preventDefault();
      }
    });
    
    // 鼠标释放
    document.addEventListener('mouseup', async (e) => {
      if (e.button === 0 && isDragging) {
        const moved = Math.abs(e.screenX - startMousePos.x) > 3 || 
                      Math.abs(e.screenY - startMousePos.y) > 3;
        isDragging = false;
        
        if (!invoke) invoke = getInvoke();
        if (invoke) {
          try {
            await invoke('icon_mouse_up', { x: e.screenX, y: e.screenY });
            if (!moved) {
              await invoke('icon_click');
            }
          } catch (err) {
            console.error('Mouse up error:', err);
          }
        }
        
        e.preventDefault();
      }
    });
    
    // 防止选中文本
    document.addEventListener('selectstart', e => e.preventDefault());
    
    // 全局鼠标释放
    window.addEventListener('mouseup', () => {
      isDragging = false;
    });
    
    document.addEventListener('mouseleave', () => {
      isDragging = false;
    });
  </script>
</body>
</html>
